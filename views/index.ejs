<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Despachos - Listado</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/static/css/styles.css" rel="stylesheet">
  <style>
    /* por si aún no lo tienes en styles.css */
    .row-aprobado { background-color: rgba(25, 135, 84, 0.12); }
  </style>
</head>
<body class="bg-light">
<%- include('partials/navbar') %>


<main class="container py-3">

  <!-- Filtros -->
  <form class="card shadow-sm mb-3" method="get" action="/">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-3">
          <label class="form-label">Buscar</label>
          <input type="text" class="form-control" name="q" value="<%= q || '' %>" placeholder="Despacho / Cliente / Aduana / Operación">
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Cliente</label>
          <select class="form-select" name="cliente">
            <option value="">Todos</option>
            <% (clientes || []).forEach(function(c){ %>
              <option value="<%= c %>" <%= (fCliente===c?'selected':'') %>><%= c %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Aduana</label>
          <select class="form-select" name="aduana">
            <option value="">Todas</option>
            <% (aduanas || []).forEach(function(a){ %>
              <option value="<%= a %>" <%= (fAduana===a?'selected':'') %>><%= a %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Ejecutivo</label>
          <select class="form-select" name="ejecutivo">
            <option value="">Todos</option>
            <% (ejecutivos || []).forEach(function(ej){ %>
              <option value="<%= ej %>" <%= (fEjecutivo===ej?'selected':'') %>><%= ej %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label">Pedidor</label>
          <select class="form-select" name="pedidor">
            <option value="">Todos</option>
            <% (pedidores || []).forEach(function(p){ %>
              <option value="<%= p %>" <%= (fPedidor===p?'selected':'') %>><%= p %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-6 col-md-1">
          <label class="form-label">Desde</label>
          <input type="date" class="form-control" name="from" value="<%= fFrom || '' %>">
        </div>
        <div class="col-6 col-md-1">
          <label class="form-label">Hasta</label>
          <input type="date" class="form-control" name="to" value="<%= fTo || '' %>">
        </div>

        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-primary"><i class="bi bi-funnel"></i> Aplicar</button>
          <a class="btn btn-outline-secondary" href="/"><i class="bi bi-x-circle"></i> Limpiar</a>
        </div>
      </div>
    </div>
  </form>

  <!-- Upload XML principal -->
  <form class="card shadow-sm mb-3" method="post" action="/upload-xml" enctype="multipart/form-data">
    <div class="card-body d-flex flex-wrap align-items-center gap-2">
      <div class="me-auto">
        <strong>Registros:</strong> <%= total || 0 %>
      </div>
      <input type="file" name="xml" accept=".xml" class="form-control" style="max-width:320px">
      <button class="btn btn-dark" type="submit"><i class="bi bi-upload"></i> Subir XML</button>
    </div>
  </form>
  <!-- Tabla -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Despacho</th>
            <th>Recepción</th>
            <th>Cliente</th>
            <th>Ejecutivo</th>
            <th>Pedidor</th>
            <th>Carga</th>
            <th>Estado</th>
            <th class="text-nowrap">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% if (!(rows||[]).length) { %>
            <tr><td colspan="8" class="text-center text-muted py-4">Sin resultados</td></tr>
          <% } %>

          <% (rows||[]).forEach(function(r){ 
               var cargaTxt = (r.carga && (r.carga.tipoBulto||r.carga.modalidad)) 
                                ? ((r.carga.tipoBulto||'') + (r.carga.modalidad?(' · '+r.carga.modalidad):'')) 
                                : '';
          %>
            <tr class="<%= r.aprobado ? 'row-aprobado' : '' %>">
              <td class="fw-semibold"><%= r.DESPACHO %></td>
              <td><%= r.FECHA_INGRESO_FMT || '' %></td>
              <td><%= r.CLIENTE_NOMBRE || '' %></td>
              <td><%= r.EJECUTIVO_NOMBRE || '' %></td>
              <td><%= r.pedidor_final || '' %></td>
              <td><%= cargaTxt %></td>
              <td>
                <% if (r.estadoTxt) { %>
                  <span class="badge text-bg-<%= r.estadoCls %>"><%= r.estadoLbl %></span>
                <% } else { %>
                  <span class="badge text-bg-light text-muted">—</span>
                <% } %>
                <% if (r.aprobado && r.aprobadoDateFmt) { %>
                  <div class="small text-muted mt-1">Aprobado: <%= r.aprobadoDateFmt %></div>
                <% } %>
              </td>
              <td class="text-nowrap">
                <!-- Upload PDF -->
                <form class="d-inline" method="post" action="/upload/<%= encodeURIComponent(r.DESPACHO) %>" enctype="multipart/form-data">
                  <label class="btn btn-outline-dark btn-sm mb-0" title="Subir PDF">
                    <i class="bi bi-cloud-upload"></i>
                    <input type="file" name="pdf" accept="application/pdf" hidden onchange="this.form.submit()">
                  </label>
                </form>

                <!-- Ver/Eliminar PDF -->
                <!-- Ver PDF -->
<% if (r.pdfPath) { %>
  <a class="btn btn-outline-success btn-sm btn-view-pdf"
     href="/pdf/view/<%= encodeURIComponent(r.DESPACHO) %>"
     target="_blank" title="Ver PDF">
    <i class="bi bi-filetype-pdf"></i>
  </a>
      <!-- Eliminar PDF (coincide con app.js: .btn-pdf-del) -->
    <button type="button"
            class="btn btn-outline-danger btn-sm btn-pdf-del"
            data-d="<%= r.DESPACHO %>"
            title="Eliminar PDF">
      <i class="bi bi-trash"></i>
    </button>
  <% } else { %>
    <button class="btn btn-outline-secondary btn-sm" type="button" disabled title="Sin PDF">
      <i class="bi bi-filetype-pdf"></i>
    </button>
  <% } %>

                <!-- Checklist -->
                <button type="button" class="btn btn-outline-secondary btn-sm btn-checklist"
                        data-d="<%= r.DESPACHO %>" title="Checklist / Carga">
                  <i class="bi bi-ui-checks"></i>
                </button>

                <!-- Revisión -->
                <button type="button" class="btn btn-outline-primary btn-sm btn-revision"
                        data-d="<%= r.DESPACHO %>" title="Mover a Revisión">
                  <i class="bi bi-arrow-repeat"></i>
                </button>

                <!-- Asignar -->
                <button type="button" class="btn btn-outline-info btn-sm btn-asignar"
                        data-d="<%= r.DESPACHO %>" data-ped="<%= r.pedidor_final || '' %>"
                        title="Asignar pedidor">
                  <i class="bi bi-person-check"></i>
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="card-body d-flex justify-content-between align-items-center">
      <div class="small text-muted">
        Página <%= page || 1 %> de <%= totalPages || 1 %> — <%= total || 0 %> registros
      </div>
      <div class="btn-group">
        <a class="btn btn-outline-secondary btn-sm <%= (page<=1?'disabled':'') %>" href="/?page=<%= (page||1)-1 %>">« Anterior</a>
        <a class="btn btn-outline-secondary btn-sm <%= (page>=(totalPages||1)?'disabled':'') %>" href="/?page=<%= (page||1)+1 %>">Siguiente »</a>
      </div>
    </div>
  </div>
</main>

<!-- Modales compartidos (opcional) -->
<%- include('partials_modales') %>

<!-- Toast container -->
<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
<script src="/static/js/app.js" defer></script>
</body>
</html>
